<!DOCTYPE html>
<html>
    <head>
        <title>Escena 3D</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script type="text/javascript" src="js/MD5.js"></script>
        <script type="text/javascript" src="js/hashCode.js"></script>
        <script type="text/javascript" src="js/glMatrix-0.9.5.min.js"></script>
        <script type="text/javascript" src="js/webgl-utils.js"></script>
        <script type="text/javascript" src="js/tstrip-utils.js"></script>
        <script type="text/javascript" src="js/shader-utils.js"></script>
        <script type="text/javascript" src="js/shader-programs.js"></script>

        <script type="text/javascript" src="js/cono.js"></script>
        <script type="text/javascript" src="js/cilindro.js"></script>
        <script type="text/javascript" src="js/caja.js"></script>
        <script type="text/javascript" src="js/primitivas.js"></script>
        <script type="text/javascript" src="js/canion.js"></script>
        <script type="text/javascript" src="js/torreta.js"></script>
        <script type="text/javascript" src="js/base-torreta.js"></script>
        
        <script type="text/javascript">
            
            var cono = new Cono(64, 10, 0.5);
            var cilindro = new Cilindro(64, 10);
            var caja = new Caja(4, 5);
            var canion = new Canion();
            var torreta = new Torreta();
            var baseTorreta = new BaseTorreta();
            var frame = 0;
            var angY = 0*1.6;
            
            function drawScene() {
                gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                
                var pMatrix = mat4.create();
                mat4.perspective(30, gl.viewportWidth / gl.viewportHeight,
                    0.1, 100.0, pMatrix);
                
                var camara = mat4.create();
                mat4.identity(camara);
                mat4.translate(camara, [0, 0, -10]);
                //mat4.rotateX(camara, Math.PI / 8);
                /*
                var rotX = mat4.create();
                mat4.identity(rotX);
                mat4.rotate(rotX, -Math.PI / 2, [1, 0, 0]);
                var rotZ = mat4.create();
                mat4.identity(rotZ);
                mat4.rotate(rotZ, frame*0.01, [0, 0, 1]);
                
                var mvMatrix = mat4.create();
                mat4.identity(mvMatrix);
                mat4.multiply(mvMatrix, camara);
                mat4.multiply(mvMatrix, rotX);
                mat4.multiply(mvMatrix, rotZ);
                
                cono.draw(new ConoDrawContext(gl, pMatrix, mvMatrix));
                
                var escalaCaja = mat4.create();
                mat4.identity(escalaCaja);
                mat4.scale(escalaCaja, [0.2, 0.2, 1]);
                var transCaja = mat4.create();
                mat4.identity(transCaja);
                mat4.translate(transCaja, [cono.getRadioMin(), cono.zmax + 0.8, cono.getRadioMin()]);
                var rotY = mat4.create();
                mat4.identity(rotY);
                mat4.rotate(rotY, -Math.PI / 2, [0, 1, 0]);
                
                mat4.identity(mvMatrix);
                mat4.multiply(mvMatrix, camara);
                //mat4.multiply(mvMatrix, rotX);
                mat4.multiply(mvMatrix, transCaja);
                mat4.multiply(mvMatrix, rotY);
                mat4.multiply(mvMatrix, escalaCaja);
                
                caja.draw(new CajaDrawContext(gl, pMatrix, mvMatrix));

                var radioMin = cono.getRadioMin();
                var escala = mat4.create();
                mat4.identity(escala);
                mat4.scale(escala, [radioMin, radioMin, 1]);
                var posY = mat4.create();
                mat4.identity(posY);
                mat4.translate(posY,[0, cono.zmax, 0]);
                
                mat4.identity(mvMatrix);
                mat4.multiply(mvMatrix, camara);
                mat4.multiply(mvMatrix, posY);
                mat4.multiply(mvMatrix, rotX);
                mat4.multiply(mvMatrix, rotZ);
                mat4.multiply(mvMatrix, escala);
                cilindro.draw(new CilindroDrawContext(gl, pMatrix, mvMatrix));
                        */

                var rotZ = mat4.create();
                mat4.identity(rotZ);
                mat4.rotate(rotZ, frame*0.01, [1, 0, 0]);
                
                var rotY = mat4.create();
                mat4.identity(rotY);
                mat4.rotate(rotY, angY, [0, 1, 0]);

                var mvMatrix = mat4.create();
                mat4.identity(mvMatrix);
                mat4.multiply(mvMatrix, camara);
                mat4.multiply(mvMatrix, rotY);
                mat4.multiply(mvMatrix, rotZ);
                //mat4.scale(mvMatrix, [0.5, 0.5, 0.5]);
                //torreta.draw(new TorretaDrawContext(gl, pMatrix, mvMatrix));
                baseTorreta.draw(new BaseTorretaDrawContext(gl, pMatrix, mvMatrix));
            }
            
            function tick() {
                requestAnimFrame(tick);
                //frame += 1;
                drawScene();
            }
            
            function start() {
                var canvas = document.getElementById("escena");
                gl = WebGLUtils.setupWebGL(canvas);
                if (gl) {
                    gl.viewportHeight = canvas.height;
                    gl.viewportWidth = canvas.width;
                    gl.clearColor(0.0, 0.0, 0.0, 1.0);
                    gl.enable(gl.DEPTH_TEST);
                    
                    cono.initGL(gl);
                    cilindro.initGL(gl);
                    caja.initGL(gl);
                    canion.initGL(gl);
                    torreta.initGL(gl);
                    baseTorreta.initGL(gl);
                    
                    tick();
                }
            }
            function onKeyUp(e){	
                var evtobj=window.event? event : e;
                var unicode=evtobj.charCode? evtobj.charCode : evtobj.keyCode
                var actualkey=String.fromCharCode(unicode)

                if (actualkey==="D") {
                        baseTorreta.guiniada += 0.1;
                } else if (actualkey==="A"){
                        baseTorreta.guiniada -= 0.1;
                } else if (actualkey==="W"){
                        baseTorreta.cabeceo += 0.1;
                } else if (actualkey==="S"){
                        baseTorreta.cabeceo -= 0.1;
                } else if (actualkey==="F"){
                        baseTorreta.guiniada = 0;
                } else if (actualkey==="R"){
                        baseTorreta.cabeceo = 0;
                }
            }
        </script>
    </head>
    <body onload="start();"
          onkeyup="onKeyUp(event)">
        <canvas
            id="escena"
            width="800"
            height="600">
        </canvas>        
    </body>
</html>
