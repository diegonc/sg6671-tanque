<!DOCTYPE html>
<html>
    <head>
        <title>Escena 3D</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script type="text/javascript" src="js/MD5.js"></script>
        <script type="text/javascript" src="js/hashCode.js"></script>
        <script type="text/javascript" src="js/glMatrix-0.9.5.min.js"></script>
        <script type="text/javascript" src="js/webgl-utils.js"></script>
        <script type="text/javascript" src="js/tstrip-utils.js"></script>
        <script type="text/javascript" src="js/shader-utils.js"></script>
        <script type="text/javascript" src="js/shader-programs.js"></script>
        <script type="text/javascript" src="js/poligono.js"></script>

        <script type="text/javascript" src="js/cono.js"></script>
        <script type="text/javascript" src="js/cilindro.js"></script>
        <script type="text/javascript" src="js/caja.js"></script>
        <script type="text/javascript" src="js/primitivas.js"></script>
        <script type="text/javascript" src="js/canion.js"></script>
        <script type="text/javascript" src="js/torreta.js"></script>
        <script type="text/javascript" src="js/base-torreta.js"></script>
        <script type="text/javascript" src="js/carroceria.js"></script>
        <script type="text/javascript" src="js/rueda.js"></script>
        <script type="text/javascript" src="js/tanque.js"></script>
        
        <script type="text/javascript">
            var tanque = new Tanque();
            
            var frame = 0;
            var angY = 0*1.6;
            var zoom = 70;
            
            function drawScene() {
                gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                
                var pMatrix = mat4.create();
                mat4.perspective(30, gl.viewportWidth / gl.viewportHeight,
                    0.1, 100.0, pMatrix);
                
                var camara = mat4.create();
                mat4.identity(camara);
                mat4.translate(camara, [0, 0, -zoom]);

                var rotZ = mat4.create();
                mat4.identity(rotZ);
                mat4.rotate(rotZ, frame*0.01, [1, 0, 0]);
                
                var rotY = mat4.create();
                mat4.identity(rotY);
                mat4.rotate(rotY, angY, [0, 1, 0]);

                var mvMatrix = mat4.create();
                mat4.identity(mvMatrix);
                mat4.multiply(mvMatrix, camara);
                mat4.multiply(mvMatrix, rotZ);
                mat4.multiply(mvMatrix, rotY);

                tanque.draw(new TanqueDrawContext(gl, pMatrix, mvMatrix));
            }

            function tick() {
                requestAnimFrame(tick);
                //frame += 1;
                drawScene();
                tanque.rotacionRTI += 0.1;
                tanque.rotacionRTD += 0.1;
                tanque.rotacionRDI += 0.1;
                tanque.rotacionRDD += 0.1;
            }
            
            function start() {
                var canvas = document.getElementById("escena");
                gl = WebGLUtils.setupWebGL(canvas);
                if (gl) {
                    gl.viewportHeight = canvas.height;
                    gl.viewportWidth = canvas.width;
                    gl.clearColor(0.0, 0.0, 0.0, 1.0);
                    gl.enable(gl.DEPTH_TEST);

                    tanque.initGL(gl);
                    
                    tick();
                }
            }
            function onKeyUp(e){
                var evtobj=window.event? event : e;
                var unicode=evtobj.charCode? evtobj.charCode : evtobj.keyCode;
                var actualkey=String.fromCharCode(unicode);

                if (actualkey==="D") {
                        tanque.baseTorreta.guiniada += 0.1;
                } else if (actualkey==="A"){
                        tanque.baseTorreta.guiniada -= 0.1;
                } else if (actualkey==="W"){
                        tanque.baseTorreta.cabeceo += 0.1;
                } else if (actualkey==="S"){
                        tanque.baseTorreta.cabeceo -= 0.1;
                } else if (actualkey==="F"){
                        tanque.baseTorreta.guiniada = 0;
                } else if (actualkey==="R"){
                        tanque.baseTorreta.cabeceo = 0;
                }
            }
        </script>
    </head>
    <body onload="start();"
          onkeyup="onKeyUp(event)">
        <canvas
            id="escena"
            width="800"
            height="600">
        </canvas>        
    </body>
</html>
