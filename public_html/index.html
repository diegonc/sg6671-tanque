<!DOCTYPE html>
<html>
    <head>
        <title>Escena 3D</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script type="text/javascript" src="js/MD5.js"></script>
        <script type="text/javascript" src="js/hashCode.js"></script>
        <script type="text/javascript" src="js/glMatrix-0.9.5.min.js"></script>
        <script type="text/javascript" src="js/webgl-utils.js"></script>
        <script type="text/javascript" src="js/webgl-debug.js"></script>
        <script type="text/javascript" src="js/cannon.js"></script>
        <script type="text/javascript" src="js/simulador-fisico.js"></script>
        
        <script type="text/javascript" src="js/tstrip-utils.js"></script>
        <script type="text/javascript" src="js/shader-utils.js"></script>
        <script type="text/javascript" src="js/shader-programs.js"></script>
        <script type="text/javascript" src="js/poligono.js"></script>
        <script type="text/javascript" src="js/light.js"></script>

        <script type="text/javascript" src="js/cono.js"></script>
        <script type="text/javascript" src="js/cilindro.js"></script>
        <script type="text/javascript" src="js/caja.js"></script>
        <script type="text/javascript" src="js/primitivas.js"></script>
        <script type="text/javascript" src="js/canion.js"></script>
        <script type="text/javascript" src="js/torreta.js"></script>
        <script type="text/javascript" src="js/base-torreta.js"></script>
        <script type="text/javascript" src="js/carroceria.js"></script>
        <script type="text/javascript" src="js/rueda.js"></script>
        <script type="text/javascript" src="js/tanque.js"></script>
        <script type="text/javascript" src="js/mundo.js"></script>
        
        <script type="text/javascript">
            var currentShader = undefined;
            var mundo = new Mundo();
            var simulador = new Simulador();
            
            var frame = 0;
            var angY = 0*1.6;
            var zoom = 70;
            
            var light = new Light(
                [0.2, 0.2, 0.2], // ambientColor
                [100.0, 100.0, 30.0], // World position
                [0.7, 0.7, 0.7] // directionalColor
            );
            
            function drawScene() {
                gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                
                var pMatrix = mat4.create();
                mat4.perspective(30, gl.viewportWidth / gl.viewportHeight,
                    0.1, 1000.0, pMatrix);
                
                var camara = mat4.create();
                mat4.identity(camara);
                mat4.translate(camara, [0, 0, -zoom]);

                light.applyCamera(camara);

                var rotZ = mat4.create();
                mat4.identity(rotZ);
                mat4.rotate(rotZ, frame*0.01, [1, 0, 0]);
                
                var rotY = mat4.create();
                mat4.identity(rotY);
                mat4.rotate(rotY, angY, [0, 1, 0]);

                var mvMatrix = mat4.create();
                mat4.identity(mvMatrix);
                mat4.multiply(mvMatrix, camara);
                mat4.multiply(mvMatrix, rotZ);
                mat4.multiply(mvMatrix, rotY);

                mundo.draw(new MundoDrawContext(gl, pMatrix, mvMatrix, light));
            }
            
            function updateWorld() {
                var posCannon, rotCannon;
                var pos, rot;
                // Posicion del chasis
                posCannon = simulador.tanque.chassisRb.position;
                pos = mundo.tanque.position;
                pos[0] = posCannon.x;
                pos[1] = posCannon.y;
                pos[2] = posCannon.z;
                // Rotacion del chasis
                rotCannon=simulador.tanque.getOrientacionChassis();
                rot = mundo.tanque.rotation;
                rot[0] = rotCannon.x;
                rot[1] = rotCannon.y;
                rot[2] = rotCannon.z;
                
                // Ruedas
                var ruedaIzqDelRotation=simulador.tanque.getOrientacionRuedaIzqDel();
		mundo.tanque.obj.setRuedaIDRotation(ruedaIzqDelRotation);
                
                var ruedaDerDelRotation=simulador.tanque.getOrientacionRuedaDerDel();          
		mundo.tanque.obj.setRuedaDDRotation(ruedaDerDelRotation);
            }

            function tick() {
                requestAnimFrame(tick);
                //frame += 1;
                
                simulador.update();
                updateWorld();                
                drawScene();
                
                var velMot = document.getElementById("velMot");
                var angVol = document.getElementById("angVol");
                velMot.innerHTML = simulador.tanque.velocidadMotor;
                angVol.innerHTML = simulador.tanque.anguloVolante;
            }
            
            function start() {
                var canvas = document.getElementById("escena");
                gl = WebGLUtils.setupWebGL(canvas);
                if (gl) {
                    gl = WebGLDebugUtils.makeDebugContext(gl);
                    gl.viewportHeight = canvas.height;
                    gl.viewportWidth = canvas.width;
                    gl.clearColor(0.0, 0.0, 0.0, 1.0);
                    gl.enable(gl.DEPTH_TEST);

                    mundo.initGL(gl);
                    
                    tick();
                }
            }
            function onKeyUp(e){
                var evtobj=window.event? event : e;
                var unicode=evtobj.charCode? evtobj.charCode : evtobj.keyCode;
                var actualkey=String.fromCharCode(unicode);

                if (actualkey==="J") {
                        mundo.tanque.obj.baseTorreta.guiniada += 0.1;
                } else if (actualkey==="G"){
                        mundo.tanque.obj.baseTorreta.guiniada -= 0.1;
                } else if (actualkey==="Y"){
                        mundo.tanque.obj.baseTorreta.cabeceo += 0.1;
                } else if (actualkey==="H"){
                        mundo.tanque.obj.baseTorreta.cabeceo -= 0.1;
                } else if (actualkey==="K"){
                        mundo.tanque.obj.baseTorreta.guiniada = 0;
                } else if (actualkey==="I"){
                        mundo.tanque.obj.baseTorreta.cabeceo = 0;
                } else if (actualkey==="D") {
                    simulador.tanque.incrementarAnguloVolante(5);
		} else if (actualkey==="A"){
                    simulador.tanque.incrementarAnguloVolante(-5);
		} else if (actualkey==="W"){
                    simulador.tanque.incrementarVelocidad(2);
		} else if (actualkey==="S"){
                    simulador.tanque.incrementarVelocidad(-2);
		}
            }
        </script>
    </head>
    <body onload="start();"
          onkeyup="onKeyUp(event)">
        <canvas
            id="escena"
            width="800"
            height="600">
        </canvas>
        <div style="float: right;">
            <div>
                Velocidad Motor: <span id="velMot"></span>
            </div>
            <div>
                Angulo Volante: <span id="angVol"></span>
            </div>
        </div>
    </body>
</html>
